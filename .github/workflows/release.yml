name: Release

on:
  # Only run on version tags (releases)
  push:
    tags:
      - "v*"
  # Allow manual trigger
  workflow_dispatch:

env:
  # Necessary for most environments
  CGO_ENABLED: 1

jobs:
  release-build:
    name: Release Build
    strategy:
      fail-fast: false
      matrix:
        build: [linux, windows, macos]
        include:
          - build: linux
            os: ubuntu-latest
            platform: linux/amd64
          - build: windows
            os: windows-latest
            platform: windows/amd64
          - build: macos
            os: macos-latest
            platform: darwin/amd64

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.0"
          check-latest: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@latest
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            mv $(go env GOPATH)/bin/wails3.exe $(go env GOPATH)/bin/wails.exe
            echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            mv $(go env GOPATH)/bin/wails3 $(go env GOPATH)/bin/wails
            echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          else
            sudo cp $(go env GOPATH)/bin/wails3 /usr/local/bin/wails
          fi
        shell: bash

      - name: Build Application
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            wails build -platform ${{ matrix.platform }} -tags webkit2_41
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            # macOS: Build with code signing if certificates are available
            if [ -n "$MACOS_CERTIFICATE" ] && [ -n "$MACOS_CERTIFICATE_PASSWORD" ]; then
              echo "Building with code signing..."
              wails build -platform ${{ matrix.platform }} -sign -signIdentity "Developer ID Application"
            else
              echo "Building without code signing (no certificates found)..."
              wails build -platform ${{ matrix.platform }}
            fi
          else
            wails build -platform ${{ matrix.platform }}
          fi
        shell: bash
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}

      # Import macOS certificates for signing (optional - only if secrets are configured)
      - name: Import macOS Certificates
        if: matrix.os == 'macos-latest' && github.event_name != 'pull_request' && env.HAS_CERTS == 'true'
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          keychain: build
          keychain-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        env:
          HAS_CERTS: ${{ secrets.MACOS_CERTIFICATE != '' && secrets.MACOS_CERTIFICATE_PASSWORD != '' }}

      # Notarize macOS app (optional - only if secrets are configured)
      - name: Notarize macOS App
        if: matrix.os == 'macos-latest' && github.event_name != 'pull_request' && startsWith(github.ref, 'refs/tags/v') && env.HAS_NOTARIZE_SECRETS == 'true'
        run: |
          # Create a zip for notarization
          ditto -c -k --keepParent "build/bin/devtoolbox.app" "build/bin/devtoolbox.zip"

          # Submit for notarization
          xcrun notarytool submit "build/bin/devtoolbox.zip" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "build/bin/devtoolbox.app"
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          HAS_NOTARIZE_SECRETS: ${{ secrets.APPLE_ID != '' && secrets.APPLE_APP_SPECIFIC_PASSWORD != '' && secrets.APPLE_TEAM_ID != '' }}

      # Package and upload build artifacts
      - name: Package Artifacts
        run: |
          mkdir -p release
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            # macOS: create DMG using create-dmg
            brew install create-dmg
            # Clean up any existing files
            rm -f release/devtoolbox-${{ matrix.build }}.dmg
            rm -f /tmp/rw.*.devtoolbox-${{ matrix.build }}.dmg
            create-dmg \
              --volname "devtoolbox" \
              --window-pos 200 120 \
              --window-size 800 400 \
              --icon-size 100 \
              --app-drop-link 600 185 \
              "release/devtoolbox-${{ matrix.build }}.dmg" \
              "build/bin/devtoolbox.app"
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows: Wails already outputs .exe, just copy it
            cp build/bin/devtoolbox.exe release/devtoolbox-${{ matrix.build }}.exe
          else
            # Linux: create AppImage or tar.gz
            tar -czf "release/devtoolbox-${{ matrix.build }}.tar.gz" -C build/bin devtoolbox
          fi
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devtoolbox-${{ matrix.build }}-${{ github.ref_name }}
          path: release/*

      # Create Release and upload assets (only on tags)
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
